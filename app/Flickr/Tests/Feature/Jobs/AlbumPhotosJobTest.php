<?php

namespace App\Flickr\Tests\Feature\Jobs;

use App\Flickr\Jobs\AlbumPhotosJob;
use App\Flickr\Tests\AbstractFlickrTest;
use App\Models\FlickrAlbum;
use App\Models\FlickrContact;
use App\Models\FlickrPhoto;
use App\Services\Flickr\FlickrService;
use Illuminate\Support\Facades\Event;

class AlbumPhotosJobTest extends AbstractFlickrTest
{
    public function setUp(): void
    {
        parent::setUp(); // TODO: Change the autogenerated stub
        Event::fake();
    }

    public function test_can_get_album_photos()
    {
        $this->buildMock(true);
        $this->service = app(FlickrService::class);

        $contact = FlickrContact::factory()->create(['nsid' => '94529704@N02',]);
        $album = FlickrAlbum::factory()->create(['owner' => $contact->nsid,]);

        // Get photos of album
        AlbumPhotosJob::dispatch($album);
        $this->assertEquals($contact->nsid, $album->owner()->first()->nsid);
        $this->assertEquals(FlickrAlbum::STATE_PHOTOS_COMPLETED, $album->refresh()->state_code);
        $photo = $album->photos()->first();
        $this->assertDatabaseHas('flickr_photos', [
            'id' => $photo->id,
            'owner' => $contact->nsid,
            'state_code' => FlickrPhoto::STATE_INIT
        ]);

        $this->assertDatabaseHas('flickr_photo_album', [
            'album_id' => $album->id,
            'photo_id' => $photo->id,
        ]);

        $this->assertEquals(16, $album->photos()->count());
        $this->assertEquals('28891387978', $album->photos()->first()->id);
    }

    public function test_cant_get_album_photos()
    {
        $this->buildMock(false);
        $this->service = app(FlickrService::class);

        $album = FlickrAlbum::factory()->create();

        AlbumPhotosJob::dispatch($album);
        $this->assertEquals(FlickrAlbum::STATE_PHOTOS_FAILED, $album->refresh()->state_code);
    }
}
